name: Import and Deploy API Proxy

on:
  push:
    branches:
      - main

jobs:
  import_and_deploy_proxy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up environment variables
      run: |
        # Set variables
        zip_file="apiproxy.zip"
        org_name="zebra-prod"
        env_name="stage"
        
        # Print variables for debugging
        echo "Zip File: $zip_file"
        echo "Org Name: $org_name"
        echo "Env Name: $env_name"

    - name: Import API Proxy
      run: |
        # Import the API proxy using curl
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.PROD_APIGEE_BEARER_TOKEN }}" \
          -F "file=@$zip_file" \
          "https://api.enterprise.apigee.com/v1/organizations/$org_name/apis?action=import&validate=true"

    - name: Deploy API Proxy to Stage
      run: |
        # Deploy the API proxy to the specified environment
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.PROD_APIGEE_BEARER_TOKEN }}" \
          "https://api.enterprise.apigee.com/v1/organizations/$org_name/apis/api_proxy/revisions/1/deployments?action=deploy&env=$env_name"
